---
title: "MSE_analysis"
author: "Haikun Xu"
date: "`r Sys.Date()`"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initial_setup}

library(tidyr)
library(dplyr)
library(ggplot2)

# Specify path of parent directory
pdir = "D:/OneDrive - IATTC/IATTC/2025/MSE/Test/"

# Specify the path of conditioned initial OM
sdir = "D:/OneDrive - IATTC/IATTC/2025/SAC16/BET F30/"

# Dimensions
library(IATTCMSE)
library(foreach)
library(doParallel)

#Specify path of parent directory
pdir <- "D:/OneDrive - IATTC/IATTC/2025/MSE/Test/"

#Specify the path of conditioned initial OM
sdir <- "D:/OneDrive - IATTC/IATTC/2025/SAC16/BET F30/"

# Dimensions
niterations <- 5
nyears <- 9
nquarters <- nyears * 4
Mcycle <- 3
nsteps <- nyears / Mcycle
endquarter <- 196
startquarter <- 17
n_extra_R <- 2 #number of assessment period recruitment in the projection
EM_comp_fleet <- c(4, 23) # fleets with comps in ASPM Rdevs+

# # simulate and save recruitment devs
# set.seed(123)
# seeds <- sample(1:1e3, size = niterations, replace = FALSE)  # Sample 5 elements without replacement
# write.csv(seeds, file = paste0(pdir,"seeds.csv"), row.names = FALSE)
# 
# R_devs <- matrix(NA, nrow = nquarters, ncol = niterations)
# for (i in 1:niterations) {
#   set.seed(seeds[i])
#   R_devs[,i] <- rnorm(n = nquarters, mean = 0, sd = 0.6) - 0.6 ^ 2 / 2
# }
# 
# write.csv(R_devs, file = paste0(pdir,"R_devs.csv"), row.names = FALSE)

OM_name <- c("Fix-1-1", "Sel-1-1")
HCR_name <- c("HCR_staff", "HCR_staff_0")

# Set the harvest strategy
HSnum <- 1
HS <- paste0("HS", HSnum, "/")

# Set the HCR
HCRnum <- 2
HCR <- paste0(HCR_name[HCRnum], "/")

# Set the scenario
OMnum <- 2
OM <- paste0(OM_name[OMnum], "/")
```

```{r management_output}

# extract saved management output
for (itrnum in 1:niterations) {
  itr = paste0("itr", itrnum, "/")
  Record <- read.csv(paste0(paste0(pdir, HS, HCR, OM, itr, "Record.csv")))
  Record$Step <- 1:nsteps
  Record$OM <- OM_name[OMnum]
  Record$itr <- itrnum
  
  if(itrnum == 1) Record_all <- Record
  else Record_all <- rbind(Record_all, Record)
}

Record_all$itr <- as.factor(Record_all$itr)

ggplot(data = Record_all) +
  geom_line(aes(x = Step, y = closure, color = itr)) +
  geom_point(aes(x = Step, y = closure, color = itr)) +
  theme_bw()
  
ggplot(data = Record_all) +
  geom_line(aes(x = Step, y = SBR_d, color = itr)) +
  geom_point(aes(x = Step, y = SBR_d, color = itr)) +
  theme_bw()

ggplot(data = Record_all) +
  geom_line(aes(x = Step, y = Fadjust, color = itr)) +
  geom_point(aes(x = Step, y = Fadjust, color = itr)) +
  geom_hline(yintercept = 1) +
  ylab("F/F30%") + 
  theme_bw()
```

```{r}
for (itrnum in 1:niterations) {
  itr = paste0("itr", itrnum, "/")
  Output <- read.csv(paste0(paste0(pdir, HS, HCR, OM, itr, "Output.csv")))
  Output$OM <- OM_name[OMnum]
  Output$itr <- itrnum
  
  if(itrnum == 1) Output_all <- Output
  else Output_all <- rbind(Output_all, Output)
}

Output_all_long <- Output_all %>%
  mutate(itr = as.factor(itr),
         Year = Year / 4 + 1974.875) %>%
  gather(2:7, key = "Quantity", value = "Value")

ggplot(data = Output_all_long %>% filter(Year > 2020, Quantity != "R_devs")) +
  geom_line(aes(x = Year, y = Value, color = itr)) +
  geom_point(aes(x = Year, y = Value, color = itr)) +
  geom_vline(xintercept = c(seq(0, nyears, Mcycle) + 2023.875)) +
  facet_wrap(~Quantity, scales = "free_y", nrow = 6) +
  theme_bw()
```

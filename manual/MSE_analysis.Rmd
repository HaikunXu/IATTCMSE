---
title: "MSE_analysis"
author: "Haikun Xu"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r initial_setup}

library(tidyr)
library(dplyr)
library(ggplot2)

# Specify path of parent directory
pdir = "D:/OneDrive - IATTC/IATTC/2025/MSE/Test/"

# Specify the path of conditioned initial OM
sdir = "D:/OneDrive - IATTC/IATTC/2025/SAC16/BET F30/"

# Dimensions
# Nfisheries <- 22
niterations <- 10
nyears <- 15
nquarters <- nyears * 4
Mcycle <- 3
nsteps <- nyears / Mcycle
# endquarter <- 196
# startquarter <- 17
n_extra_R <- 2 #number of assessment period recruitment in the projection

OM_name <- "Fix-1-1"
# Set the harvest strategy
HSnum <- 1
HS <- paste0("HS", HSnum, "/")

# Set the HCR
HCRnum <- 1
HCR <- paste0("HCR", HCRnum, "/")

# Set the scenario
OMnum <- 1
OM <- paste0(OM_name[OMnum], "/")
```

```{r management_output}

# extract saved management output
for (itrnum in c(1,7)) { # :niterations) {
  itr = paste0("itr", itrnum, "/")
  Record <- read.csv(paste0(paste0(pdir, HS, HCR, OM, itr, "Record.csv")))
  Record$Step <- 1:nsteps
  Record$OM <- OM_name[OMnum]
  Record$itr <- itrnum
  
  if(itrnum == 1) Record_all <- Record
  else Record_all <- rbind(Record_all, Record)
}

Record_all$itr <- as.factor(Record_all$itr)

ggplot(data = Record_all) +
  geom_line(aes(x = Step, y = closure, color = itr)) +
  geom_point(aes(x = Step, y = closure, color = itr)) +
  theme_bw()
  
ggplot(data = Record_all) +
  geom_line(aes(x = Step, y = SBR_d, color = itr)) +
  geom_point(aes(x = Step, y = SBR_d, color = itr)) +
  theme_bw()

ggplot(data = Record_all) +
  geom_line(aes(x = Step, y = Fmult, color = itr)) +
  geom_point(aes(x = Step, y = Fmult, color = itr)) +
  theme_bw()
```

```{r}
for (itrnum in c(1,7)) { # :niterations) {
  itr = paste0("itr", itrnum, "/")
  Output <- read.csv(paste0(paste0(pdir, HS, HCR, OM, itr, "Output.csv")))
  Output$OM <- OM_name[OMnum]
  Output$itr <- itrnum
  
  if(itrnum == 1) Output_all <- Output
  else Output_all <- rbind(Output_all, Output)
}

Output_all_long <- Output_all %>%
  mutate(itr = as.factor(itr)) %>%
  gather(2:7, key = "Quantity", value = "Value")

ggplot(data = Output_all_long %>% filter(Year > 180)) +
  geom_line(aes(x = Year, y = Value, color = itr)) +
  geom_point(aes(x = Year, y = Value, color = itr)) +
  geom_vline(xintercept = 196) +
  facet_wrap(~Quantity, scales = "free_y", nrow = 6) +
  theme_bw()
```
